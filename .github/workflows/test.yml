name: Automated Tests

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - synchronize
  workflow_dispatch:

permissions:
  contents: read

env:
  SDK_VERSION: "9.0.300"
  XCODE_VERSION: "26.0"

jobs:
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Restore dependencies
        run: |
          dotnet restore TRViS.IO.Tests/TRViS.IO.Tests.csproj
          dotnet restore TRViS.LocationService.Tests/TRViS.LocationService.Tests.csproj

      - name: Run IO Tests
        run: dotnet test TRViS.IO.Tests/TRViS.IO.Tests.csproj --no-restore --verbosity normal --logger "trx;LogFileName=io-test-results.trx"

      - name: Run LocationService Tests
        run: dotnet test TRViS.LocationService.Tests/TRViS.LocationService.Tests.csproj --no-restore --verbosity normal --logger "trx;LogFileName=location-test-results.trx"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: "**/*-test-results.trx"
          retention-days: 7

  test-ios:
    name: iOS UI Tests
    runs-on: macos-26
    timeout-minutes: 30
    permissions:
      contents: read

    env:
      WITHOUT_ANDROID: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1.6.0
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Install dotnet workloads
        run: dotnet workload install maui-ios maccatalyst

      - name: Restore and Build TRViS app
        run: |
          dotnet restore TRViS/TRViS.csproj
          dotnet build TRViS/TRViS.csproj -f net9.0-ios -c Debug --no-restore

      - name: Find TRViS assembly
        id: find-assembly
        run: |
          ASSEMBLY_PATH=$(find TRViS/bin/Debug/net9.0-ios -name "TRViS.dll" | head -n 1)
          echo "assembly_path=$ASSEMBLY_PATH" >> $GITHUB_OUTPUT
          echo "Found assembly at: $ASSEMBLY_PATH"

      - name: Run UI Tests
        run: |
          export TRVIS_ASSEMBLY_PATH="${{ steps.find-assembly.outputs.assembly_path }}"
          dotnet test TRViS.UITests/TRViS.UITests.csproj --verbosity normal --logger "trx;LogFileName=ios-ui-test-results.trx"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ui-test-results
          path: "**/*-test-results.trx"
          retention-days: 7

  test-macos:
    name: macOS UI Tests
    runs-on: macos-26
    timeout-minutes: 30
    permissions:
      contents: read

    env:
      WITHOUT_ANDROID: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1.6.0
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Install dotnet workloads
        run: dotnet workload install maui-ios maccatalyst

      - name: Restore and Build TRViS app
        run: |
          dotnet restore TRViS/TRViS.csproj
          dotnet build TRViS/TRViS.csproj -f net9.0-maccatalyst -c Debug --no-restore

      - name: Find TRViS assembly
        id: find-assembly
        run: |
          ASSEMBLY_PATH=$(find TRViS/bin/Debug/net9.0-maccatalyst -name "TRViS.dll" | head -n 1)
          echo "assembly_path=$ASSEMBLY_PATH" >> $GITHUB_OUTPUT
          echo "Found assembly at: $ASSEMBLY_PATH"

      - name: Run UI Tests
        run: |
          export TRVIS_ASSEMBLY_PATH="${{ steps.find-assembly.outputs.assembly_path }}"
          dotnet test TRViS.UITests/TRViS.UITests.csproj --verbosity normal --logger "trx;LogFileName=macos-ui-test-results.trx"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-ui-test-results
          path: "**/*-test-results.trx"
          retention-days: 7

  test-android:
    name: Android UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Install dotnet workloads
        run: dotnet workload install maui-android

      - name: Restore and Build TRViS app
        run: |
          dotnet restore TRViS/TRViS.csproj
          dotnet build TRViS/TRViS.csproj -f net9.0-android -c Debug --no-restore

      - name: Find TRViS assembly
        id: find-assembly
        run: |
          ASSEMBLY_PATH=$(find TRViS/bin/Debug/net9.0-android -name "TRViS.dll" | head -n 1)
          echo "assembly_path=$ASSEMBLY_PATH" >> $GITHUB_OUTPUT
          echo "Found assembly at: $ASSEMBLY_PATH"

      - name: Run UI Tests
        run: |
          export TRVIS_ASSEMBLY_PATH="${{ steps.find-assembly.outputs.assembly_path }}"
          dotnet test TRViS.UITests/TRViS.UITests.csproj --verbosity normal --logger "trx;LogFileName=android-ui-test-results.trx"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-ui-test-results
          path: "**/*-test-results.trx"
          retention-days: 7

  test-windows:
    name: Windows UI Tests
    runs-on: windows-latest
    timeout-minutes: 30
    permissions:
      contents: read

    env:
      WITHOUT_ANDROID: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Install dotnet workloads
        run: dotnet workload install maui-windows

      - name: Restore and Build TRViS app
        run: |
          dotnet restore TRViS/TRViS.csproj
          dotnet build TRViS/TRViS.csproj -f net9.0-windows10.0.19041.0 -c Debug --no-restore

      - name: Find TRViS assembly
        id: find-assembly
        shell: pwsh
        run: |
          $ASSEMBLY_PATH = (Get-ChildItem -Path "TRViS\bin\Debug\net9.0-windows10.0.19041.0" -Filter "TRViS.dll" -Recurse | Select-Object -First 1).FullName
          echo "assembly_path=$ASSEMBLY_PATH" >> $env:GITHUB_OUTPUT
          echo "Found assembly at: $ASSEMBLY_PATH"

      - name: Run UI Tests
        shell: pwsh
        run: |
          $env:TRVIS_ASSEMBLY_PATH = "${{ steps.find-assembly.outputs.assembly_path }}"
          dotnet test TRViS.UITests/TRViS.UITests.csproj --verbosity normal --logger "trx;LogFileName=windows-ui-test-results.trx"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-ui-test-results
          path: "**/*-test-results.trx"
          retention-days: 7
