name: Automated Tests

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - synchronize
  workflow_dispatch:

env:
  SDK_VERSION: "9.0.300"

jobs:
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Restore dependencies
        run: dotnet restore TRViS.IO.Tests/TRViS.IO.Tests.csproj

      - name: Run IO Tests
        run: dotnet test TRViS.IO.Tests/TRViS.IO.Tests.csproj --no-restore --verbosity normal --logger "trx;LogFileName=io-test-results.trx"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: "**/*.trx"
          retention-days: 7

  test-ios:
    name: iOS UI Tests
    runs-on: macos-15
    timeout-minutes: 30

    env:
      WITHOUT_ANDROID: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1.6.0
        with:
          xcode-version: 16

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Install dotnet workloads
        run: dotnet workload install maui-ios

      - name: Restore dependencies
        run: dotnet restore TRViS.UITests/TRViS.UITests.csproj

      - name: List available simulators
        run: xcrun xctrace list devices

      - name: Boot simulator
        run: |
          SIMULATOR_ID=$(xcrun xctrace list devices 2>&1 | grep -m 1 "iPhone" | grep -oE "\([0-9A-F-]{36}\)" | tr -d "()")
          echo "Booting simulator with ID: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID" || true
          xcrun simctl list | grep Booted

      - name: Build and Run iOS UI Tests
        run: |
          SIMULATOR_ID=$(xcrun xctrace list devices 2>&1 | grep -m 1 "iPhone" | grep -oE "\([0-9A-F-]{36}\)" | tr -d "()")
          echo "Running tests on simulator: $SIMULATOR_ID"
          dotnet build TRViS.UITests/TRViS.UITests.csproj -f net9.0-ios -c Release -p:RuntimeIdentifier=iossimulator-x64 -p:_DeviceName=:v2:udid=$SIMULATOR_ID

      - name: Shutdown simulator
        if: always()
        run: xcrun simctl shutdown all || true

  test-macos:
    name: macOS UI Tests
    runs-on: macos-15
    timeout-minutes: 30

    env:
      WITHOUT_ANDROID: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1.6.0
        with:
          xcode-version: 16

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Install dotnet workloads
        run: dotnet workload install maccatalyst

      - name: Restore dependencies
        run: dotnet restore TRViS.UITests/TRViS.UITests.csproj

      - name: Build and Run macOS UI Tests
        run: |
          dotnet build TRViS.UITests/TRViS.UITests.csproj -f net9.0-maccatalyst -c Release

  test-android:
    name: Android UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Install dotnet workloads
        run: dotnet workload install maui-android

      - name: Restore dependencies
        run: dotnet restore TRViS.UITests/TRViS.UITests.csproj

      - name: Build Android UI Tests
        run: |
          dotnet build TRViS.UITests/TRViS.UITests.csproj -f net9.0-android -c Release

  test-windows:
    name: Windows UI Tests
    runs-on: windows-latest
    timeout-minutes: 30

    env:
      WITHOUT_ANDROID: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.SDK_VERSION }}

      - name: Install dotnet workloads
        run: dotnet workload install maui-windows

      - name: Restore dependencies
        run: dotnet restore TRViS.UITests/TRViS.UITests.csproj

      - name: Build Windows UI Tests
        run: |
          dotnet build TRViS.UITests/TRViS.UITests.csproj -f net9.0-windows10.0.19041.0 -c Release
